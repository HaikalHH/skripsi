# WhatsApp Finance Assistant MVP (Monorepo)

MVP chatbot keuangan pribadi berbasis WhatsApp dengan AI (Gemini + Vision OCR), penyimpanan MySQL (Prisma), admin monitoring web, dan chart PNG dari Python service.

## Architecture

- End-user interface: **WhatsApp only**
- Bot: **Baileys multi-device** (`apps/bot`)
- Backend API: **Next.js 14 route handlers** (`apps/api`)
- Admin panel (admin-only): **Next.js 14** (`apps/admin-web`)
- Reporting image: **FastAPI + Matplotlib PNG** (`services/reporting`)
- Shared schemas/types/prompts: `packages/shared`
- Database: MySQL + Prisma

## Monorepo Structure

```text
.
|- apps/
|  |- admin-web/
|  |- api/
|  `- bot/
|- packages/
|  `- shared/
|- services/
|  `- reporting/
|- package.json
|- pnpm-workspace.yaml
`- tsconfig.base.json
```

## Core MVP Features Implemented

1. WhatsApp text/image flow:
   - text: intent classification + extraction (Gemini)
   - image: OCR (Vision API) -> normalization (Gemini) -> transaction insert
2. Auto user record creation by WhatsApp number on first message (status `PENDING`); user must type `register` to start registration.
3. Transaction schema + message logging + AI analysis logging in Prisma.
4. Reporting `/report daily|weekly|monthly`:
   - aggregation in API
   - chart PNG generated by Python service
   - bot sends summary text + image
5. Simple budget/goals:
   - budget per category (`Budget.monthlyLimit`)
   - savings goal (`SavingsGoal`)
   - budget exceed alert message
6. Admin web:
   - env password login
   - Users list, Transactions table + filters, Subscriptions status update, System health
7. Security/config:
   - secrets in env
   - zod validation for payloads + AI output
   - in-memory rate limiting per WA number
   - graceful fallback when AI/OCR fails (no partial transaction insert)
8. Tests:
   - extraction parsing
   - aggregation logic
9. New user onboarding + dummy payment:
   - unregistered users must type `register` to start registration Q&A
   - other messages from unregistered users are blocked with register prompt
   - bot sends dummy payment link (`/pay/{token}`)
   - payment confirmation activates subscription
   - bot sends activation notification automatically

## Prerequisites

- Node.js 20+
- pnpm 9+
- MySQL 8+
- Python 3.11+
- Google Gemini API key
- Google Cloud Vision API key

## Environment Files

Copy and edit:

- `apps/api/.env.example` -> `apps/api/.env`
- `apps/admin-web/.env.example` -> `apps/admin-web/.env`
- `apps/bot/.env.example` -> `apps/bot/.env`
- `services/reporting/.env.example` -> `services/reporting/.env` (optional)

Important:

- `apps/api/.env`
  - `GEMINI_API_KEY`
  - `GCP_VISION_API_KEY`
  - `ADMIN_API_TOKEN`
  - `BOT_INTERNAL_TOKEN`
  - `PAYMENT_WEB_BASE_URL`
  - `DATABASE_URL`
- `apps/admin-web/.env`
  - `ADMIN_PASSWORD`
  - `ADMIN_API_TOKEN` (must match API)
  - `API_BASE_URL`
- `apps/bot/.env`
  - `API_BASE_URL` (usually `http://localhost:3001`)
  - `BOT_INTERNAL_TOKEN` (must match API)

## Local Development (No Docker)

### 1) Install dependencies

```bash
pnpm install
```

### 2) Setup MySQL local

Create database:

```sql
CREATE DATABASE finance_bot;
```

Set `DATABASE_URL` in `apps/api/.env` to your local MySQL instance, example:

```env
DATABASE_URL=mysql://finance:finance@localhost:3306/finance_bot
```

### 3) Run DB migration + seed

```bash
pnpm --filter @finance/api prisma:generate
pnpm --filter @finance/api prisma:migrate
pnpm --filter @finance/api prisma:seed
```

### 4) Run reporting service (Python)

```bash
cd services/reporting
python -m venv .venv
# Windows PowerShell:
. .venv/Scripts/Activate.ps1
# macOS/Linux:
# source .venv/bin/activate
pip install -r requirements.txt
uvicorn app.main:app --reload --port 8000
```

### 5) Run API + Admin + Bot (separate terminals)

```bash
pnpm dev:api
pnpm dev:admin
pnpm dev:bot
```

On first bot run, QR appears in terminal.

### 6) Scan QR (Baileys session)

In WhatsApp mobile:

1. Open WhatsApp Settings
2. Linked Devices
3. Link a Device
4. Scan QR shown in terminal (`apps/bot`)

Auth state is stored in `apps/bot/.baileys_auth`.

## Admin Login

- Open `http://localhost:3000/login`
- Login with `ADMIN_PASSWORD` from `apps/admin-web/.env`

## Useful Commands

```bash
pnpm dev:api
pnpm dev:admin
pnpm dev:bot
pnpm --filter @finance/api test
```

## Sample WhatsApp Commands + Expected Response

1. `makan siang 45000`
   - expected: transaction confirmation (type/amount/category/date)
2. `gaji 5000000`
   - expected: income transaction confirmation
3. `/report daily`
   - expected: summary text + PNG chart
4. `/report weekly`
   - expected: summary text + PNG chart
5. `/report monthly`
   - expected: summary text + PNG chart
6. `/insight`
   - expected: short rule-based + AI insight text
7. `/help`
   - expected: command list
8. `register` (for new/unregistered number)
   - expected: start onboarding question 1/4
9. `/budget set makan 1500000`
   - expected: budget kategori tersimpan + sisa budget bulan ini
10. `/goal set 10000000`
   - expected: target tabungan tersimpan + progress saat ini
11. `/goal status`
   - expected: status progress tabungan terbaru

## New User Flow

1. User sends any message and gets prompt to type `register`.
2. User types `register`.
3. Bot asks registration questions (Q&A).
4. After registration complete, bot sends dummy payment link.
5. User opens payment page and clicks `Paid`.
6. Subscription becomes active and bot sends activation notification.

## API Notes

- Main bot ingress: `POST /api/bot/inbound`
- Heartbeat: `POST /api/bot/heartbeat`
- Bot outbound queue:
  - `GET /api/bot/outbound`
  - `POST /api/bot/outbound/ack`
- Public payment endpoints:
  - `GET /api/public/payment/session?token=...`
  - `POST /api/public/payment/confirm`
- Admin endpoints (require header `x-admin-token`):
  - `GET /api/admin/users`
  - `GET /api/admin/transactions`
  - `GET/PATCH /api/admin/subscriptions`
  - `GET /api/admin/health`

## Testing

```bash
pnpm --filter @finance/api test
```

Current tests:

- `apps/api/tests/ai-parsing.test.ts`
- `apps/api/tests/aggregation.test.ts`

## Assumptions

1. Single MySQL database for all modules.
2. In-memory rate limit is sufficient for MVP (not distributed).
3. Admin auth is env-password + cookie session (no RBAC/JWT/OAuth yet).
4. Amount/category extraction relies on Gemini strict JSON response.
5. If OCR/Gemini/reporting fails, bot returns fallback message and does not store partial transaction data.
6. End-user dashboard is intentionally omitted; admin-web is monitoring-only.

## Production Hardening (Next Steps)

1. Replace in-memory rate limiter with Redis.
2. Add retry queue and idempotency keys for inbound message processing.
3. Add secret manager + stricter env validation at deploy time.
4. Add integration tests for inbound flow and report chart endpoint.
5. Add admin audit log for subscription changes.
